---
description: Phase 2 contract context after pivot: private supply via Aave-style pool with vault factory isolation.
globs: *
---

# PHASE 2 CONTEXT (PRIVATE SUPPLY)

Objective:

- Validate `Unshield -> Vault (per zk owner) -> Aave supply` flow.

Implemented contracts:

1. `contracts/PrivateSupplyAdapter.sol`
- Callback entrypoint: `onRailgunUnshield(token, amount, data)`.
- Decodes `SupplyRequest { zkOwnerHash }`.
- Gets or creates user vault through `VaultFactory`.
- Transfers token to vault and calls vault supply into Aave pool.
- Stores `positions[positionId]`.

2. `contracts/VaultFactory.sol`
- One vault per `zkOwnerHash`.
- `setAdapter` + `getOrCreateVault`.

3. `contracts/UserVault.sol`
- Isolated per-user vault.
- `supply` and future-ready `withdrawToAdapter`.

4. `contracts/mocks/MockAavePool.sol`
- Deterministic supply accounting for tests/smoke.

5. `contracts/mocks/MockRailgun.sol`
- Mock callback + shield endpoint.

6. `contracts/mocks/MockUSDC.sol`
- 6-decimal ERC20 test token.

7. `contracts/test/PrivateSupplyAdapter.t.sol`
- Happy path + callback access control.

Scripts:

1. `scripts/deploy-vault-factory.sh`
2. `scripts/deploy-mock-aave-pool.sh`
3. `scripts/deploy-mock-railgun.sh`
4. `scripts/deploy-private-supply-adapter.sh`
5. `scripts/smoke-test-supply-adapter.sh`

Required env keys (phase 2):

- `RPC_URL`
- `DEPLOYER_PRIVATE_KEY`
- `SUPPLY_TOKEN`
- `MOCK_AAVE_POOL`
- `AAVE_POOL`
- `MOCK_RAILGUN`
- `VAULT_FACTORY`
- `PRIVATE_SUPPLY_ADAPTER`
- `RAILGUN_CALLBACK_SENDER`
- `RAILGUN_SHIELD`
- Legacy `AMOY_*` keys are accepted as fallback in scripts.

Do not regress:

1. Keep `onlyRailgunCallback` restriction.
2. Keep per-user vault isolation (`zkOwnerHash -> vault`).
3. Keep scripts using safe `.env` parser (no direct `source .env` assumptions).
